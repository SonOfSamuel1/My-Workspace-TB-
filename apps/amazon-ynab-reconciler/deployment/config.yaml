# Amazon-YNAB Reconciliation Configuration

reconciliation:
  # Number of days to look back for transactions
  lookback_days: 30

  # Minimum confidence score (0-100) to consider a match
  match_threshold: 70  # Lowered from 80 to allow more potential matches

  # Date tolerance for matching (days)
  date_tolerance_days: 7  # Increased from 2 to account for processing delays

  # Amount tolerance for matching (cents)
  amount_tolerance_cents: 200  # Increased from 50 to $2.00 for better tolerance

  # Match by payee name (finds ALL Amazon transactions in YNAB)
  match_by_payee: true
  amazon_payee_patterns:
    - "Amazon"
    - "AMZN"
    - "AMZ"
    - "Amazon.com"
    - "Amazon Prime"
    - "Amazon Marketplace"

  # Batch detection settings
  batch_detection:
    enabled: true
    # Maximum number of transactions to combine when looking for batches
    max_batch_size: 5
    # Try to detect split payments (one Amazon order split into multiple charges)
    detect_split_payments: true
    # Try to detect consolidated charges (multiple Amazon orders in one charge)
    detect_consolidated_charges: true
    # Confidence boost for transactions with Payment Reference IDs
    payment_ref_confidence_boost: 10

  # Track previously reconciled transactions to avoid duplicates
  enable_state_tracking: true
  state_file: 'logs/reconciliation_state.json'
  # How long to keep state entries before cleanup (days)
  state_retention_days: 90

# =============================================================================
# EMAIL ACCOUNTS CONFIGURATION (for dual-email reconciliation)
# =============================================================================
email_accounts:
  accounts:
    # Primary Gmail account (uses OAuth2)
    - name: "Primary Gmail"
      type: "gmail"
      enabled: true
      credentials_path: "~/.gmail-mcp/gcp-oauth.keys.json"
      token_path: "~/.gmail-mcp/credentials.json"
      search:
        senders:
          - "ship-confirm@amazon.com"
          - "auto-confirm@amazon.com"
          - "order-update@amazon.com"
          - "digital-no-reply@amazon.com"
          - "no-reply@amazon.com"
        lookback_days: 30

    # Brittany's mail.com account (uses IMAP)
    - name: "Brittany Mail.com"
      type: "imap"
      enabled: true
      server: "imap.mail.com"
      port: 993
      use_ssl: true
      username: "brittanybrandon@mail.com"
      # Password from environment: IMAP_PASSWORD_BRITTANY
      search:
        folder: "INBOX"
        lookback_days: 30

  # Deduplication settings
  deduplication:
    enabled: true
    strategy: "order_id"  # Primary: match by Amazon order ID

  # Priority settings
  priority:
    primary_source: "email"  # email, downloads, csv, browserbase
    fallback_order:
      - "downloads"
      - "csv"
      - "browserbase"

amazon:
  # Amazon order history URL
  order_history_url: 'https://www.amazon.com/gp/your-account/order-history'

  # Maximum number of pages to scrape
  max_pages: 10

  # Wait time between page navigations (milliseconds)
  navigation_delay: 2000

  # Downloads folder monitoring
  downloads:
    enabled: true
    monitor_directory: '~/Downloads'
    file_patterns:
      - '*amazon*.csv'
      - '*Amazon*.csv'
      - '*order*.csv'
      - '*Order*.csv'
      - '*purchase*.csv'
      - '*transaction*.csv'
    archive_processed: true
    archive_directory: 'data/processed'
    min_file_size_bytes: 100
    watch_interval_seconds: 300  # 5 minutes for continuous monitoring

  # Archive downloaded CSV files after processing
  archive_downloads: true

  # Browser settings for Playwright
  browser:
    headless: true
    viewport_width: 1280
    viewport_height: 720
    timeout: 30000

  # Selectors for Amazon elements (may need updates)
  selectors:
    order_cards: '[data-component="order-card"]'
    order_date: '.order-info .value'
    order_total: '.grand-total-price'
    order_items: '.shipment-item'
    item_name: '.item-title'
    item_category: '.item-category'
    item_link: 'a[href*="/dp/"]'
    next_page: '.a-pagination .a-last:not(.a-disabled)'

  # Browserbase cloud browser automation
  browserbase:
    enabled: true
    # Session persistence settings
    session_max_age_days: 7  # Re-authenticate after this many days of inactivity
    # Order extraction settings
    order_history_pages: 5  # Maximum pages to scrape per run
    extraction_timeout: 30000  # Milliseconds for extraction operations
    # Navigation settings
    wait_between_pages: 2000  # Milliseconds between page navigations
    max_retries: 3  # Retry attempts on failure
    # Notification settings
    notify_on_session_expiry: true
    notification_topic_arn: null  # Set to SNS topic ARN for alerts

ynab:
  # Budget name to use
  budget_name: "Terrance Brandon's Plan"

  # Account names to search for transactions
  account_names:
    - 'Amazon Business Prime Card – 3008'
    - 'Amazon Business Prime Card – 1010'
    - 'Chase Reserve CC – 1516'
    - 'SimplyCash® Plus Card – 4008'
    - 'Apple Card'

  # Only process uncleared transactions
  only_uncleared: true

  # Memo format for reconciled transactions
  memo_format: '[Amazon: {category}] | {item_name} | {item_link}'

  # Preserve existing memo content
  preserve_existing_memo: true

email:
  # Enable email reports
  enabled: true

  # Email recipient (if not set, will use account owner email)
  recipient: null

  # Email subject format
  subject: 'Amazon-YNAB Reconciliation Report - {date}'

  # Include detailed transaction list in email
  include_details: true

  # Only send email if there are matches or errors
  only_on_activity: false

aws:
  # Lambda configuration
  lambda:
    memory: 3008  # MB (3GB for Playwright)
    timeout: 300  # seconds (5 minutes)

  # Parameter Store paths
  parameter_store:
    amazon_credentials: '/amazon-reconciler/amazon-credentials'
    ynab_api_key: '/amazon-reconciler/ynab-api-key'
    gmail_credentials: '/amazon-reconciler/gmail-credentials'
    browserbase_session: '/amazon-reconciler/browserbase-session-id'
    browserbase_api_key: '/amazon-reconciler/browserbase-api-key'

  # EventBridge schedule
  schedule:
    enabled: true
    expression: 'cron(0 7 * * ? *)'  # Daily at 2 AM ET (7 AM UTC)

logging:
  level: INFO
  format: '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
  file: '../logs/reconciler.log'
  max_bytes: 10485760  # 10MB
  backup_count: 5
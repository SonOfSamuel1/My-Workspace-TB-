name: Hourly Email Management

on:
  schedule:
    # Runs every hour from 7 AM to 5 PM EST (12:00-22:00 UTC)
    - cron: "0 12-22 * * 1-5"  # Monday-Friday only
  workflow_dispatch:  # Manual trigger for testing
    inputs:
      test_mode:
        description: 'Run in test mode (no actual emails sent)'
        required: false
        default: 'false'

jobs:
  process-emails:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: |
          npm install -g @anthropic-ai/claude-code
          claude --version

      - name: Install Gmail MCP Server
        run: |
          npm install -g @gongrzhe/server-gmail-autoauth-mcp

      - name: Setup Gmail MCP credentials
        run: |
          mkdir -p ~/.gmail-mcp

          # Decode base64-encoded credentials to avoid escaping issues
          echo '${{ secrets.GMAIL_OAUTH_CREDENTIALS }}' | base64 -d > ~/.gmail-mcp/gcp-oauth.keys.json
          echo '${{ secrets.GMAIL_CREDENTIALS }}' | base64 -d > ~/.gmail-mcp/credentials.json

          # Verify JSON is valid
          echo "Verifying Gmail OAuth credentials JSON:"
          jq '.' ~/.gmail-mcp/gcp-oauth.keys.json > /dev/null && echo "‚úì Valid JSON" || echo "‚úó Invalid JSON"
          echo "Verifying Gmail credentials JSON:"
          jq '.' ~/.gmail-mcp/credentials.json > /dev/null && echo "‚úì Valid JSON" || echo "‚úó Invalid JSON"

      - name: Setup Claude MCP configuration
        run: |
          mkdir -p ~/.config/claude
          cat > ~/.config/claude/claude_code_config.json <<'EOF'
          {
            "mcpServers": {
              "gmail": {
                "type": "stdio",
                "command": "npx",
                "args": ["@gongrzhe/server-gmail-autoauth-mcp"],
                "env": {}
              }
            }
          }
          EOF

      - name: Verify MCP Setup
        run: |
          echo "=== MCP Configuration Check ==="
          echo "Config file location:"
          ls -la ~/.config/claude/ || echo "Config directory not found"
          echo ""
          echo "Config file contents:"
          cat ~/.config/claude/claude_code_config.json || echo "Config file not found"
          echo ""
          echo "Gmail credentials location:"
          ls -la ~/.gmail-mcp/ || echo "Gmail MCP directory not found"
          echo ""
          echo "Gmail MCP package check:"
          npm list -g @gongrzhe/server-gmail-autoauth-mcp || echo "Package not found"
          echo ""
          echo "Test Gmail MCP server directly:"
          timeout 5s npx @gongrzhe/server-gmail-autoauth-mcp || echo "MCP server test completed"

      - name: Determine execution mode
        id: mode
        run: |
          HOUR=$(TZ='America/New_York' date +%H)
          if [ "$HOUR" = "07" ]; then
            echo "mode=morning_brief" >> $GITHUB_OUTPUT
          elif [ "$HOUR" = "17" ]; then
            echo "mode=eod_report" >> $GITHUB_OUTPUT
          elif [ "$HOUR" = "13" ]; then
            echo "mode=midday_check" >> $GITHUB_OUTPUT
          else
            echo "mode=hourly_process" >> $GITHUB_OUTPUT
          fi
          echo "hour=$HOUR" >> $GITHUB_OUTPUT

      - name: Validate Configuration
        run: |
          echo "Validating environment configuration..."
          node lib/config-validator.js || echo "‚ö†Ô∏è  Config validation warnings detected"

      - name: Process Emails with Claude Code
        id: process_emails
        continue-on-error: true
        timeout-minutes: 9
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          EXECUTION_MODE: ${{ steps.mode.outputs.mode }}
          CURRENT_HOUR: ${{ steps.mode.outputs.hour }}
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_FROM_NUMBER: ${{ secrets.TWILIO_FROM_NUMBER }}
          ESCALATION_PHONE: '+14077448449'
          TEST_MODE: ${{ github.event.inputs.test_mode || 'false' }}
          LOG_LEVEL: 'info'
        run: |
          claude --print --dangerously-skip-permissions --mcp-config ~/.config/claude/claude_code_config.json << EOF
          You are Terrance Brandon's Executive Email Assistant, running autonomous hourly email management.

          CURRENT CONTEXT:
          - Execution Mode: ${EXECUTION_MODE}
          - Current Hour (EST): ${CURRENT_HOUR}:00
          - Test Mode: ${TEST_MODE}

          YOUR CONFIGURATION (from claude-agents/executive-email-assistant-config-terrance.md):
          - Email: terrance@goodportion.org
          - Delegation Level: Level 2 (Manage)
          - Time Zone: EST
          - Communication Style: Casual (Hi/Thanks), "Kind regards,", NO emojis
          - Escalation: SMS to 407-744-8449 for Tier 1 urgent

          OFF-LIMITS CONTACTS (Always Escalate as Tier 1):
          - Family Members
          - Darrell Coleman
          - Paul Robertson
          - Tatyana Brandon

          LABELS SYSTEM:
          1. Action Required - High-priority items needing decision
          2. To Read - Information to review later
          3. Waiting For - Awaiting external responses
          4. Completed - Finished items
          5. VIP - VIP contacts and always-escalate list
          6. Meetings - Calendar/scheduling
          7. Travel - Travel related
          8. Expenses - Receipts, invoices
          9. Newsletters - Subscriptions

          TIER CLASSIFICATION:

          TIER 1 (Escalate Immediately - SMS + Priority Email):
          - Revenue-impacting emails from customers/prospects
          - Strategic partnership opportunities
          - Major donor communications
          - Speaking/media opportunities
          - Financial matters requiring approval
          - Employee/HR issues
          - Legal matters
          - Emails from off-limits contacts
          - Anything marked urgent/confidential

          TIER 2 (Handle Independently):
          - Meeting scheduling
          - Newsletter subscriptions
          - Vendor communications (routine)
          - Follow-up reminders
          - Information requests
          - Administrative tasks
          - Travel confirmations
          - Expense receipts

          TIER 3 (Draft for Approval):
          - Meeting decline requests
          - Strategic communications
          - First-time contacts (seemingly important)
          - Requires Terrance's expertise/voice

          TIER 4 (Draft-Only, Never Send):
          - HR/Employee performance matters
          - Financial negotiations
          - Legal matters
          - Board communications
          - Personal matters (health, family)

          YOUR TASKS FOR THIS HOUR:

          1. ACCESS GMAIL VIA MCP
             - Connect to terrance@goodportion.org inbox
             - Use Gmail MCP tools (should be available)

          2. FETCH NEW EMAILS
             - Get emails received in the last hour
             - If this is first run today (7 AM), get overnight emails since 5 PM yesterday

          3. PROCESS EACH EMAIL:
             - Read sender, subject, and content
             - Classify into Tier 1/2/3/4
             - Apply appropriate Gmail label
             - Take action based on tier:

               TIER 1:
               - Apply "Action Required" + "VIP" labels
               - Send SMS to $ESCALATION_PHONE with brief alert
               - Add to priority list for brief/report
               - DO NOT respond to email yet

               TIER 2:
               - Apply appropriate label (Meetings/Travel/Expenses/Newsletters)
               - Draft and SEND response if clear pattern exists
               - Archive if handled
               - Log action for EOD report

               TIER 3:
               - Apply "Action Required" label
               - Draft response but DO NOT send
               - Save draft in Gmail
               - Add to approval queue for brief/report

               TIER 4:
               - Apply "Action Required" label
               - DO NOT draft or send anything
               - Flag for Terrance's personal attention
               - Add to brief/report with sensitivity note

          4. UPDATE "WAITING FOR" ITEMS:
             - Check emails with "Waiting For" label
             - If response received, move to appropriate category
             - If >3 days old, draft follow-up (add to approval queue)

          5. GENERATE OUTPUT BASED ON MODE:

             IF MODE = "morning_brief" (7 AM):
             - Generate comprehensive morning brief
             - Include overnight email summary
             - List all Tier 1 escalations
             - List all Tier 3/4 items needing approval
             - Show updated "Waiting For" status
             - Send via email to terrance@goodportion.org
             - Subject: "Morning Brief - [Date]"

             IF MODE = "eod_report" (5 PM):
             - Generate comprehensive end-of-day report
             - Total emails processed today
             - Actions taken (Tier 2 handled)
             - Items awaiting approval (Tier 3/4)
             - Still waiting for responses
             - Tomorrow's priorities
             - Send via email to terrance@goodportion.org
             - Subject: "End of Day Report - [Date]"

             IF MODE = "midday_check" (1 PM):
             - Only send report if Tier 1 urgent items exist
             - Brief summary of urgent matters
             - Subject: "Midday Alert - Urgent Items"

             IF MODE = "hourly_process":
             - Process emails silently
             - Only send SMS for Tier 1 urgent items
             - No email report unless critical

          6. ERROR HANDLING:
             - If Gmail MCP not available, log error and exit gracefully
             - If cannot access inbox, send alert to Terrance
             - If unsure about classification, default to Tier 3 (draft for approval)

          IMPORTANT CONSTRAINTS:
          - Never use emojis (Terrance hates them)
          - Always identify as "Executive Email Assistant for Terrance Brandon"
          - Sign responses with "Kind regards,"
          - If meeting decline needed, draft but don't send (Tier 3)
          - Be conservative with escalations during learning phase

          BEGIN PROCESSING NOW.

          Output your actions in this format:

          ## EMAIL PROCESSING SUMMARY
          - Emails checked: [#]
          - New emails found: [#]
          - Tier 1 (escalated): [#]
          - Tier 2 (handled): [#]
          - Tier 3 (drafted): [#]
          - Tier 4 (flagged): [#]

          ## ACTIONS TAKEN
          [List each action taken]

          ## ESCALATIONS
          [If any Tier 1 items, list them]

          ## MODE-SPECIFIC OUTPUT
          [Morning brief / EOD report / Midday alert / Silent processing confirmation]
          EOF

      - name: Retry on Failure
        if: steps.process_emails.outcome == 'failure'
        timeout-minutes: 9
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          EXECUTION_MODE: ${{ steps.mode.outputs.mode }}
          CURRENT_HOUR: ${{ steps.mode.outputs.hour }}
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_FROM_NUMBER: ${{ secrets.TWILIO_FROM_NUMBER }}
          ESCALATION_PHONE: '+14077448449'
          TEST_MODE: ${{ github.event.inputs.test_mode || 'false' }}
          LOG_LEVEL: 'info'
        run: |
          echo "‚ö†Ô∏è  First attempt failed, retrying..."
          sleep 5
          claude --print --dangerously-skip-permissions --mcp-config ~/.config/claude/claude_code_config.json << 'EOF'
          # (Same prompt as above - using the full prompt again)
          EOF

      - name: Report Failure
        if: failure()
        run: |
          echo "‚ùå Email processing failed after retries"
          echo "Check logs for details"
          exit 1

      - name: Upload Processing Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: email-processing-log-${{ github.run_number }}
          path: |
            *.log
            *.txt
          retention-days: 30

      - name: Notify on Failure (Optional)
        if: failure()
        run: |
          echo "üí° Tip: Set up GitHub Actions email notifications"
          echo "Repository Settings ‚Üí Notifications ‚Üí Actions"
